(()=>{var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var s=e.g.document;if(!t&&s&&(s.currentScript&&(t=s.currentScript.src),!t)){var n=s.getElementsByTagName("script");n.length&&(t=n[n.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.p=window.wcpayAssets.url,(()=>{"use strict";window.wp.domReady;const t=e=>"undefined"!=typeof wcpayConfig?wcpayConfig[e]:s(e),s=e=>{let t=null;if("undefined"!=typeof wcpay_upe_config)t=wcpay_upe_config;else{if("object"!=typeof wc||void 0===wc.wcSettings)return null;t=wc.wcSettings.getSetting("woocommerce_payments_data")||{}}return t[e]||null},n=e=>(e=>"object"==typeof wcpayExpressCheckoutParams&&wcpayExpressCheckoutParams.hasOwnProperty(e)?wcpayExpressCheckoutParams[e]:"object"==typeof wcpayPaymentRequestParams&&wcpayPaymentRequestParams.hasOwnProperty(e)?wcpayPaymentRequestParams[e]:null)(e),o=function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"wcpay_";return e.toString().replace("%%endpoint%%",s+t)};const a=()=>{return e=void 0,s=void 0,a=function*(){var e,s,o;let a=(()=>{const e=document.cookie.split(";");for(let t=0;t<e.length;t++){let s=e[t];for(;" "===s.charAt(0);)s=s.substring(1,s.length);if(0===s.indexOf("tk_ai="))return s.substring(6,s.length)}})();if(a){const e={_ut:"anon",_ui:a};return JSON.stringify(e)}const i=null!==(e=t("platformTrackerNonce"))&&void 0!==e?e:null===(s=n("nonce"))||void 0===s?void 0:s.platform_tracker,r=null!==(o=t("ajaxUrl"))&&void 0!==o?o:n("ajax_url"),c=new FormData;c.append("tracksNonce",i),c.append("action","get_identity");try{const e=yield fetch(r,{method:"post",body:c});if(!e.ok)return;const t=yield e.json();return t.success&&t.data&&t.data._ui&&t.data._ut?JSON.stringify(t.data):void 0}catch(e){return}},new((o=void 0)||(o=Promise))((function(t,n){function i(e){try{c(a.next(e))}catch(e){n(e)}}function r(e){try{c(a.throw(e))}catch(e){n(e)}}function c(e){var s;e.done?t(e.value):(s=e.value,s instanceof o?s:new o((function(e){e(s)}))).then(i,r)}c((a=a.apply(e,s||[])).next())}));var e,s,o,a};function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments.length>2?arguments[2]:void 0;for(const n in e){const o=e[n],a=t?t+"["+n+"]":n;"string"==typeof o||"number"==typeof o?s.append(a,o):"object"==typeof o&&i(o,a,s)}return s}async function r(e,t,s){const n=i(t,"",new FormData),o=await fetch(e,{method:"POST",body:n,...s});return await o.json()}const c=window.wp.element,d=window.React,l=window.wp.i18n;function u(e){window.WooPayConnect||(window.WooPayConnect={}),window.WooPayConnect.iframeInjectedState=e}const h=()=>{const e=(0,d.useRef)(),[s,n]=(0,d.useState)("");return(0,d.useEffect)((()=>{(async()=>{const e=t("testMode"),s=t("woopayHost"),o=t("woopayMerchantId"),i=new URLSearchParams({testMode:e,source_url:window.location.href,blogId:o}),r=await a();r&&i.append("tracksUserIdentity",r),n(`${s}/connect/?${i.toString()}`)})()}),[]),(0,d.useEffect)((()=>{if(!e.current)return;const s=e.current;s.addEventListener("load",(()=>{u(2),window.dispatchEvent(new MessageEvent("message",{source:window,origin:t("woopayHost"),data:{action:"get_iframe_post_message_success",value:e=>s.contentWindow.postMessage(e,t("woopayHost"))}}))}))}),[s]),(0,c.createElement)("iframe",{ref:e,id:"woopay-connect-iframe",src:s,style:{height:0,width:0,border:"none",margin:0,padding:0,overflow:"hidden",display:"block",visibility:"hidden",position:"fixed",pointerEvents:"none",userSelect:"none"},title:(0,l.__)("WooPay Connect Direct Checkout","woocommerce-payments")})},p=window.ReactDOM;var y=e.n(p);const m=class{iframePostMessage=null;listeners={};constructor(){this.listeners={getIframePostMessageCallback:()=>{}},this.removeMessageListener=this.attachMessageListener(),this.injectWooPayConnectIframe()}attachMessageListener(){const e=e=>{t("woopayHost").startsWith(e.origin)&&this.callbackFn(e.data)};return window.addEventListener("message",e),()=>{window.removeEventListener("message",e)}}detachMessageListener(){"function"==typeof this.removeMessageListener&&this.removeMessageListener()}injectWooPayConnectIframe(){const e=window?.WooPayConnect?.iframeInjectedState||0;if(2===e){const e=document.querySelector("#woopay-connect-iframe");return void(e&&(this.iframePostMessage=Promise.resolve((s=>{e.contentWindow.postMessage(s,t("woopayHost"))}))))}if(1===e)return void(this.iframePostMessage=new Promise((e=>{this.listeners.getIframePostMessageCallback=e})));u(1);const s=document.createElement("div");s.style.visibility="hidden",s.style.position="fixed",s.style.height="0",s.style.width="0",s.style.bottom="0",s.style.right="0",s.id="woopay-connect-iframe-container",document.body.appendChild(s);const n=this;this.iframePostMessage=new Promise((e=>{n.listeners.getIframePostMessageCallback=e})),y().render((0,c.createElement)(h,null),s)}injectTemporaryWooPayConnectIframe(){let e;const s=new Promise((t=>{e=t})),n=document.createElement("iframe");return n.id="temp-woopay-connect-iframe",n.src=t("woopayHost")+"/connect/",n.height=0,n.width=0,n.border="none",n.margin=0,n.padding=0,n.overflow="hidden",n.display="block",n.visibility="hidden",n.position="fixed",n.pointerEvents="none",n.userSelect="none",n.addEventListener("load",(()=>{e((e=>n.contentWindow.postMessage(e,t("woopayHost"))))})),document.body.appendChild(n),{resolvePostMessagePromise:s,removeTemporaryIframe:()=>{document.body.removeChild(n)}}}async sendMessageAndListenWith(e,t){const s=new Promise((e=>{this.listeners[t]=e}));return(await this.iframePostMessage)(e),await s}callbackFn(e){"get_iframe_post_message_success"===e.action&&this.listeners.getIframePostMessageCallback(e.value)}},w=class extends m{constructor(){super(),this.listeners={...this.listeners,getIsUserLoggedInCallback:()=>{},getEncryptedDataCallback:()=>{}}}async isUserLoggedIn(){return await this.sendMessageAndListenWith({action:"getIsUserLoggedIn"},"getIsUserLoggedInCallback")}async getEncryptedData(){return await this.sendMessageAndListenWith({action:"getEncryptedData"},"getEncryptedDataCallback")}callbackFn(e){switch(super.callbackFn(e),e.action){case"get_is_user_logged_in_success":this.listeners.getIsUserLoggedInCallback(e.value);break;case"get_encrypted_data_success":this.listeners.getEncryptedDataCallback(e.value)}}},g=class extends m{constructor(){super(),this.listeners={...this.listeners,setRedirectSessionDataCallback:()=>{},setTempThirdPartyCookieCallback:()=>{},getIsThirdPartyCookiesEnabledCallback:()=>{},setPreemptiveSessionDataCallback:()=>{}}}async isWooPayThirdPartyCookiesEnabled(){const{resolvePostMessagePromise:e,removeTemporaryIframe:t}=this.injectTemporaryWooPayConnectIframe(),s=new Promise((e=>{this.listeners.setTempThirdPartyCookieCallback=e})),n=await e;if(n({action:"setTempThirdPartyCookie"}),!await s)return!1;const o=new Promise((e=>{this.listeners.getIsThirdPartyCookiesEnabledCallback=e}));n({action:"getIsThirdPartyCookiesEnabled"});const a=await o;return t(),a}async sendRedirectSessionDataToWooPay(e){return await super.sendMessageAndListenWith({action:"setRedirectSessionData",value:e},"setRedirectSessionDataCallback")}async setPreemptiveSessionData(e){return await super.sendMessageAndListenWith({action:"setPreemptiveSessionData",value:e},"setPreemptiveSessionDataCallback")}callbackFn(e){switch(super.callbackFn(e),e.action){case"set_redirect_session_data_success":this.listeners.setRedirectSessionDataCallback(e.value);break;case"set_redirect_session_data_error":this.listeners.setRedirectSessionDataCallback({is_error:!0});break;case"set_temp_third_party_cookie_success":this.listeners.setTempThirdPartyCookieCallback(e.value);break;case"get_is_third_party_cookies_enabled_success":this.listeners.getIsThirdPartyCookiesEnabledCallback(e.value);break;case"set_preemptive_session_data_success":this.listeners.setPreemptiveSessionDataCallback(e.value);break;case"set_preemptive_session_data_error":this.listeners.setPreemptiveSessionDataCallback({is_error:!0})}}},_=class{static userConnect;static sessionConnect;static encryptedSessionDataPromise;static redirectElements={CLASSIC_CART_PROCEED_BUTTON:".wc-proceed-to-checkout .checkout-button",BLOCKS_CART_PROCEED_BUTTON:".wp-block-woocommerce-proceed-to-checkout-block",BLOCKS_MINI_CART_PROCEED_BUTTON:"a.wp-block-woocommerce-mini-cart-checkout-button-block",CLASSIC_MINI_CART_PROCEED_BUTTON:".widget_shopping_cart a.button.checkout"};static init(){this.getSessionConnect()}static getUserConnect(){return this.userConnect||(this.userConnect=new w),this.userConnect}static getSessionConnect(){return this.sessionConnect||(this.sessionConnect=new g),this.sessionConnect}static teardown(){this.sessionConnect?.detachMessageListener(),this.userConnect?.detachMessageListener(),this.sessionConnect=null,this.userConnect=null}static isWooPayDirectCheckoutEnabled(){return t("isWooPayDirectCheckoutEnabled")}static async isUserLoggedIn(){return this.getUserConnect().isUserLoggedIn()}static async getEncryptedData(){return this.getUserConnect().getEncryptedData()}static async isWooPayThirdPartyCookiesEnabled(){return this.getSessionConnect().isWooPayThirdPartyCookiesEnabled()}static async getWooPayCheckoutUrl(){try{let e;if(e=this.isEncryptedSessionDataPrefetched()?await this.encryptedSessionDataPromise:await this.getEncryptedSessionData(),!this.isValidEncryptedSessionData(e))throw new Error("Could not retrieve encrypted session data from store.");const t=await this.getSessionConnect().sendRedirectSessionDataToWooPay(e);if(!t?.redirect_url)throw new Error("Could not retrieve WooPay checkout URL.");const{redirect_url:s}=t;if(!this.validateRedirectUrl(s,"platform_checkout_key"))throw new Error("Invalid WooPay session URL: "+s);return t.redirect_url}catch(e){throw new Error(e.message)}}static isValidEncryptedSessionData(e){return e&&e?.blog_id&&e?.data?.session&&e?.data?.iv&&e?.data?.hash}static async getWooPayMinimumSessionUrl(){const e=await this.getWooPayMinimumSesssionDataFromMerchant();if(!1===e?.success)throw new Error("Could not retrieve redirect data from merchant.");if(!this.isValidEncryptedSessionData(e))throw new Error("Invalid encrypted session data.");const{blog_id:s,data:{session:n,iv:o,hash:a}}=e,i=new URLSearchParams({checkout_redirect:1,blog_id:s,session:n,iv:o,hash:a});return t("woopayHost")+"/woopay/?"+i.toString()}static getCheckoutButtonElements(){const e=[],t=t=>{const s=document.querySelector(t);s&&e.push(s)};return t(this.redirectElements.CLASSIC_CART_PROCEED_BUTTON),t(this.redirectElements.BLOCKS_CART_PROCEED_BUTTON),t(this.redirectElements.CLASSIC_MINI_CART_PROCEED_BUTTON),e}static getClassicProceedToCheckoutButton(){return document.querySelector(this.redirectElements.CLASSIC_CART_PROCEED_BUTTON)}static getMiniCartProceedToCheckoutButton(){return document.querySelector(this.redirectElements.BLOCKS_MINI_CART_PROCEED_BUTTON)}static addRedirectToWooPayEventListener(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.forEach((e=>{const s={is_loading:!1};e.addEventListener("click",(async n=>{if(s.is_loading)return void n.preventDefault();let o;if(s.is_loading=!0,(e=>{if(e.classList.contains("wp-block-woocommerce-mini-cart-checkout-button-block"))return!0;const t=e.classList.contains("checkout-button"),s=e.parentElement?.classList?.contains("wc-proceed-to-checkout");return t&&s})(e)&&(e=>{const t=document.createElement("span");t.classList.add("wc-block-components-spinner"),t.style.position="relative",t.style.fontSize="unset",t.style.display="inline",t.style.lineHeight="0",t.style.margin="0",t.style.border="0",t.style.padding="0",e.innerHTML="&nbsp;",e.classList.remove("wc-forward"),e.appendChild(t)})(e),o="a"===e.tagName.toLowerCase()?e.href:e.querySelector("a")?.href,o){n.preventDefault();try{let e="";e=t?await this.getWooPayCheckoutUrl():await this.getWooPayMinimumSessionUrl(),this.teardown(),window.location.href=e}catch(e){console.warn(e),this.teardown(),window.location.href=o}}else this.teardown()}))}))}static async getEncryptedSessionData(){const e=await this.getEncryptedData();return r(o(t("wcAjaxUrl"),"get_woopay_session"),{_ajax_nonce:t("woopaySessionNonce"),...e&&{encrypted_data:e}})}static async getWooPayMinimumSesssionDataFromMerchant(){return t("woopayMinimumSessionData")?t("woopayMinimumSessionData"):r(o(t("wcAjaxUrl"),"get_woopay_minimum_session_data"),{_ajax_nonce:t("woopaySessionNonce")})}static validateRedirectUrl(e,s){try{const n=new URL(e);return!(n.origin!==t("woopayHost")||!n.searchParams.has(s))}catch(e){return!1}}static maybePrefetchEncryptedSessionData(){const e=window?.wcpayWooPayDirectCheckout?.params?.is_product_page;void 0===e||e||(this.encryptedSessionDataPromise=new Promise((e=>{e(this.getEncryptedSessionData())})))}static setEncryptedSessionDataAsNotPrefetched(){this.encryptedSessionDataPromise=null}static isEncryptedSessionDataPrefetched(){return"function"==typeof this.encryptedSessionDataPromise?.then}},f=()=>{const e=document.cookie.split(";").find((e=>e.includes("skip_woopay")));if(!e)return!1;const t=e?.split("=");return"skip_woopay"===t[0].trim()&&"1"===t[1].trim()},C=()=>{!function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var o,a,i;const r=null!==(o=t("platformTrackerNonce"))&&void 0!==o?o:null===(a=n("nonce"))||void 0===a?void 0:a.platform_tracker,c=null!==(i=t("ajaxUrl"))&&void 0!==i?i:n("ajax_url"),d=new FormData;d.append("tracksNonce",r),d.append("action","platform_tracks"),d.append("tracksEventName",e),d.append("tracksEventProp",JSON.stringify(s)),fetch(c,{method:"post",body:d})}("wcpay_proceed_to_checkout_button_click",{woopay_direct_checkout:Boolean(t("isWooPayDirectCheckoutEnabled"))&&!f()})};window.addEventListener("load",(()=>{Object.values(_.redirectElements).forEach((e=>{const t=document.querySelector(e);t&&t.addEventListener("click",C)})),(()=>{const e=document.querySelector(".cart-collaterals");e&&new MutationObserver((()=>{const e=document.querySelector(_.redirectElements.CLASSIC_CART_PROCEED_BUTTON);e&&e.addEventListener("click",C)})).observe(e,{childList:!0,subtree:!0})})()}))})()})();